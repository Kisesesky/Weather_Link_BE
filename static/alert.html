<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=390" />
  <title>ì„¤ì •</title>
  <style>
    body { 
      font-family: 'Pretendard', sans-serif; 
      background: #f8fafd; 
      margin: 0; 
      padding: 0;
    }
    .setting-wrap {
      max-width: 390px;
      margin: 36px auto 0;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 1px 8px #e7ecf2;
      padding: 0 0 20px 0;
      overflow: hidden;
    }
    .header {
      background: #fff;
      padding: 20px 24px 0;
      border-bottom: 1px solid #f0f2f5;
    }
    .header-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      line-height: 1.5;
    }
    .section-group {
      padding: 16px 18px;
    }
    .section-label {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #363a3f;
    }
    .row {
      margin-bottom: 16px;
    }
    select,
    .input-box {
      width: 100%;
      font-size: 15px;
      padding: 10px 12px;
      border: 1px solid #d6dae1;
      border-radius: 8px;
      background: #fafbfc;
      outline: none;
      margin-top: 5px;
    }
    .alert-setting-box {
      background: #fafdff;
      border-radius: 13px;
      padding: 16px 12px 12px;
      box-shadow: 0 1px 6px #f3f8fb;
      margin-top: 10px;
      position: relative;
    }
    .alarm-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .alarm-title {
      font-size: 15px;
      font-weight: 600;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input { display: none;}
    .slider {
      position: absolute; cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #d3dbe7;
      border-radius: 30px;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 0 2px #bbb;
    }
    .switch input:checked + .slider {
      background: #3288fd;
    }
    .switch input:checked + .slider:before {
      transform: translateX(20px);
    }
    .slider-row {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }
    .slider-label { width: 55px; font-size: 14px; color: #45494c; }
    .slider-value { width: 55px; text-align: right; font-size: 14px; font-weight: 600;}
    input[type=range] {
      flex: 1;
      accent-color: #3288fd;
      height: 3px;
      margin: 0 10px;
    }
    .select-sm {
      width: 120px;
      font-size: 15px;
      padding: 7px 10px;
      border: 1px solid #d6dae1;
      border-radius: 7px;
      background: #fafbfc;
      outline: none;
      margin-right: 10px;
    }
    .note {
      font-size: 12px;
      color: #98a2b3;
      margin-top: 9px;
      text-align: center;
      user-select: none;
    }
    .toast {
      display:none;
      position: fixed;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: #3864fd;
      color: #fff;
      border-radius: 9px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px #b7c5fd;
      font-size: 15px;
      z-index: 99;
    }
  </style>
</head>
<body>
<div class="setting-wrap">
  <div class="header">
    <div style="font-size:12px;color:#b9becb;">&larr; ì„¤ì •</div>
    <h2 class="header-title">ì„¤ì •</h2>
  </div>
  <div class="section-group">
    <div class="section-label">ìœ„ì¹˜ ì„¤ì •</div>
    <div class="row">
      <label>ì‹œ/ë„ ì„ íƒ</label>
      <select id="city" class="input-box">
        <option value="">ì‹œ/ë„ ì„ íƒ</option>
        <option>ì„œìš¸íŠ¹ë³„ì‹œ</option>
        <option>ë¶€ì‚°ê´‘ì—­ì‹œ</option>
        <option>ê²½ê¸°ë„</option>
        <option>ê°•ì›ë„</option>
      </select>
    </div>
    <div class="row">
      <label>ì‹œ/êµ°/êµ¬ ì„ íƒ</label>
      <select id="district" class="input-box">
        <option value="">ì‹œ/êµ°/êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
    </div>
  </div>
  <div class="section-group">
    <div class="section-label">ì•Œë¦¼ ì„¤ì •</div>
    <div class="alert-setting-box">
      <div class="alarm-title-row">
        <div class="alarm-title">ì•Œë¦¼</div>
        <label class="switch">
          <input type="checkbox" id="alarm-enabled" checked>
          <span class="slider"></span>
        </label>
      </div>
      <div id="alarm-fields">
        <div class="slider-row">
          <div class="slider-label">ì˜¨ë„</div>
          <input type="range" id="temp-range" min="-10" max="40" value="25">
          <span id="temp-value" class="slider-value">25â„ƒ</span>
        </div>
        <div class="slider-row">
          <div class="slider-label">ìŠµë„</div>
          <input type="range" id="humid-range" min="0" max="100" value="70">
          <span id="humid-value" class="slider-value">70%</span>
        </div>
        <div class="slider-row">
          <div class="slider-label">ë°”ëŒ</div>
          <input type="range" id="wind-range" min="0" max="30" value="15">
          <span id="wind-value" class="slider-value">15m/s</span>
        </div>
        <div class="slider-row">
          <div class="slider-label">ë¯¸ì„¸ë¨¼ì§€</div>
          <select id="pm10" class="select-sm">
            <option>ì¢‹ìŒ</option>
            <option selected>ë³´í†µ</option>
            <option>ë‚˜ì¨</option>
            <option>ë§¤ìš° ë‚˜ì¨</option>
          </select>
        </div>
      </div>
      <div class="note">
        <span>ì„¤ì •í•œ ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¼ë„ ì¶©ì¡±ë˜ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”</span>
      </div>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>
<script>
  // ì„œë²„ API ì£¼ì†Œ (ë°˜ë“œì‹œ ì‹¤ì œ API ì£¼ì†Œë¡œ êµì²´!!)
  const API_URL = 'http://localhost:3000/api/v1'; // ex) 'https://api.yoursite.com/api'

  // ì‹œêµ°êµ¬ ë°ì´í„° ì˜ˆì‹œ
  const districtMap = {
    'ì„œìš¸íŠ¹ë³„ì‹œ': ['ì¢…ë¡œêµ¬', 'ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ë§ˆí¬êµ¬'],
    'ë¶€ì‚°ê´‘ì—­ì‹œ': ['í•´ìš´ëŒ€êµ¬', 'ì¤‘êµ¬', 'ì‚¬í•˜êµ¬'],
    'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ', 'ê³ ì–‘ì‹œ', 'ìš©ì¸ì‹œ'],
    'ê°•ì›ë„': ['ì¶˜ì²œì‹œ', 'ê°•ë¦‰ì‹œ', 'ì›ì£¼ì‹œ']
  }
  document.getElementById('city').addEventListener('change', function(e) {
    const city = e.target.value
    const districtSel = document.getElementById('district');
    districtSel.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    if(districtMap[city]) {
      districtMap[city].forEach((d)=>{
        const opt = document.createElement('option');
        opt.value = d;
        opt.text = d;
        districtSel.appendChild(opt);
      });
    }
  });

  // Range ì‹¤ì‹œê°„ í‘œì‹œ
  document.getElementById('temp-range').oninput = function(){
    document.getElementById('temp-value').textContent = this.value + "â„ƒ";
  }
  document.getElementById('humid-range').oninput = function(){
    document.getElementById('humid-value').textContent = this.value + "%";
  }
  document.getElementById('wind-range').oninput = function(){
    document.getElementById('wind-value').textContent = this.value + "m/s";
  }

  // ì•Œë¦¼ì„¤ì • í† ê¸€(ì „ì²´ ON/OFF)
  document.getElementById('alarm-enabled').onchange = function() {
    const enabled = this.checked;
    document.getElementById('alarm-fields').style.display = enabled ? '' : 'none';
    toggleAllAlerts(enabled);
  }

  // DB ID ì €ì¥ (ê° íƒ€ì…ë³„)
  const settingIds = {
    TEMPERATURE: null,
    HUMIDITY: null,
    WIND: null,
    AIRQUALITY: null
  };

  // ì§ì ‘ JWT í† í° ì„¤ì • (ì‹¤ì œ í† í°ìœ¼ë¡œ êµì²´)
  const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0QHRlc3QuY29tIiwiaWF0IjoxNzQ1ODI2MDYzLCJleHAiOjE3NDU4Mjk2NjN9.IwZgO7AIpJUptBVH1FvfVM5MDQ0-UOzV1tA43NfQgys';


  // API í˜¸ì¶œ - ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ì €ì¥
  async function saveAlertSetting(type, threshold) {
    try {
        const active = document.getElementById('alarm-enabled').checked;
        const settingData = {
        type: type,
        threshold: threshold,
        active: active
        };

        let url = `${API_URL}/alert-settings`;
        let method = 'POST';

        if (settingIds[type]) {
        url = `${API_URL}/alert-settings/${settingIds[type]}`;
        method = 'PATCH';
        }

        const res = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${JWT_TOKEN}`  // localStorage ëŒ€ì‹  ìƒìˆ˜ ì‚¬ìš©
            },
            body: JSON.stringify(settingData)
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.message || "ì €ì¥ ì—ëŸ¬");
        if (result.data && result.data.id) settingIds[type] = result.data.id;
        showToast("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
    } catch (e) {
        showToast(e.message, true);
    }
  }

  // ì•Œë¦¼ ì „ì²´ ON/OFF API (PATCH /alert-settings/toggle-all)
  async function toggleAllAlerts(active) {
    const token = localStorage.getItem('accessToken');
    if (!token) return;
    try {
      await fetch(`${API_URL}/alert-settings/toggle-all`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ active })
      });
      showToast(active ? "ëª¨ë“  ì•Œë¦¼ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤." : "ëª¨ë“  ì•Œë¦¼ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤.");
    } catch (e) {
      showToast("ì „ì²´ ì•Œë¦¼ í† ê¸€ ì˜¤ë¥˜", true);
    }
  }

  // ê° ê°’ ë³€ê²½ì‹œ API ì €ì¥ (onchange ì´ë²¤íŠ¸ ì‚¬ìš©)
  document.getElementById('temp-range').onchange = function() {
    saveAlertSetting('TEMPERATURE', parseInt(this.value));
  }
  document.getElementById('humid-range').onchange = function() {
    saveAlertSetting('HUMIDITY', parseInt(this.value));
  }
  document.getElementById('wind-range').onchange = function() {
    saveAlertSetting('WIND', parseInt(this.value));
  }
  document.getElementById('pm10').onchange = function() {
    saveAlertSetting('AIRQUALITY', this.value); // ë¯¸ì„¸ë¨¼ì§€ëŠ” ë“±ê¸‰ ë¬¸ìì—´ë¡œ
  }

  // ìµœì´ˆ ë¡œë”©ì‹œ DBì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì™€ì„œ ê°’ ë°˜ì˜
  window.onload = async function() {
    await loadSettingsFromAPI();
  }

  async function loadSettingsFromAPI() {
    const token = localStorage.getItem('accessToken');
    if (!token) return;
    try {
      const res = await fetch(`${API_URL}/alert-settings`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const result = await res.json();
      if (result.data && Array.isArray(result.data)) {
        result.data.forEach(setting=>{
          settingIds[setting.type] = setting.id;
          switch (setting.type) {
            case 'TEMPERATURE':
              document.getElementById('temp-range').value = setting.threshold;
              document.getElementById('temp-value').textContent = setting.threshold + "â„ƒ";
              break;
            case 'HUMIDITY':
              document.getElementById('humid-range').value = setting.threshold;
              document.getElementById('humid-value').textContent = setting.threshold + "%";
              break;
            case 'WIND':
              document.getElementById('wind-range').value = setting.threshold;
              document.getElementById('wind-value').textContent = setting.threshold + "m/s";
              break;
            case 'AIRQUALITY':
              document.getElementById('pm10').value = getPm10Grade(setting.threshold);
              break;
          }
        });
        // í•˜ë‚˜ë¼ë„ activeë©´ ì „ì²´ toggle ON
        const anyActive = result.data.some(s=>s.active);
        document.getElementById('alarm-enabled').checked = anyActive;
        document.getElementById('alarm-fields').style.display = anyActive ? '' : 'none';
      }
    } catch (e) {
      // silent fail
    }
  }
  // ìˆ«ì â†’ ë¯¸ì„¸ë¨¼ì§€ ë“±ê¸‰ ë³€í™˜ (ì„œë²„ thresholdê°€ 0~150 ë“±ì¼ ìˆ˜ ìˆìŒ)
  function getPm10Grade(value) {
    if (typeof value === "string") return value;
    if (value >= 150) return 'ë§¤ìš° ë‚˜ì¨';
    if (value >= 80) return 'ë‚˜ì¨';
    if (value >= 30) return 'ë³´í†µ';
    return 'ì¢‹ìŒ';
  }
  // í† ìŠ¤íŠ¸ ì•Œë¦¼
  let toastTimer;
  function showToast(msg, error=false) {
    const toast = document.getElementById('toast');
    toast.style.background = error ? "#ea4b4b" : "#3864fd";
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ toast.style.display="none"; }, 1500);
  }
</script>
<!-- ... ê¸°ì¡´ ìŠ¤íƒ€ì¼/í—¤ë”ëŠ” ë™ì¼, ì•„ë˜ì— ì¶”ê°€ ... -->
<div class="section-group" style="margin-top:20px;">
    <div class="section-label">ë‚´ ì•Œë¦¼ ì„¤ì • ëª©ë¡</div>
    <div id="alert-list" style="margin-top:10px;"></div>
  </div>
  
  <script>
  
  // ì•Œë¦¼ ì•„ì´ì½˜ ë§¤í•‘
  const typeIcon = {
    TEMPERATURE: 'ğŸŒ¡ï¸',
    HUMIDITY: 'ğŸ’§',
    WIND: 'ğŸƒ',
    AIRQUALITY: 'ğŸ­'
  };
  const typeLabel = {
    TEMPERATURE: 'ì˜¨ë„', HUMIDITY: 'ìŠµë„', WIND: 'ë°”ëŒ', AIRQUALITY: 'ë¯¸ì„¸ë¨¼ì§€'
  };
  const unitLabel = {
    TEMPERATURE: 'Â°C', HUMIDITY: '%', WIND: 'm/s', AIRQUALITY: ''
  };
  
  // [1] ì•Œë¦¼ ëª©ë¡ ì¶œë ¥
  async function renderAlertList() {
    const list = await fetchAlertSettings();
    const root = document.getElementById('alert-list');
    root.innerHTML = '';
    if (!list || list.length === 0) {
      root.innerHTML = '<div style="color:#adb5bd;text-align:center;">ì €ì¥ëœ ì•Œë¦¼ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    list.forEach(s => {
      // ì„ê³„ì¹˜(ë¯¸ì„¸ë¨¼ì§€ëŠ” ë“±ê¸‰ ë¬¸ìì—´ë¡œ í‘œì‹œ)
      let val = s.type === 'AIRQUALITY' ? getPm10Grade(s.threshold) : s.threshold + unitLabel[s.type];
      root.innerHTML += `
        <div style="display:flex;align-items:center;justify-content:space-between;background:#f6f8fa;border-radius:9px;padding:10px 12px;margin-bottom:8px;">
          <div style="font-size:18px;margin-right:7px;">${typeIcon[s.type]}</div>
          <div style="flex:1;">
            <div style="font-size:15px;font-weight:500;">${typeLabel[s.type]} ì•Œë¦¼</div>
            <div style="font-size:13px;color:#9ca3af">${val}</div>
          </div>
          <label style="margin:0 10px">
            <input type="checkbox" ${s.active ? "checked" : ""} onchange="toggleAlertActive('${s.id}',this.checked)">
            <span style="color:${s.active ? '#339af0':'#adb5bd'};font-weight:600;font-size:13px;vertical-align:middle;">
              ${s.active?'ON':'OFF'}
            </span>
          </label>
          <button onclick="editAlertSetting('${s.id}')" style="background:#e9efff;border:none;border-radius:5px;padding:3px 9px;cursor:pointer;font-size:13px;">âœï¸</button>
          <button onclick="deleteAlertSetting('${s.id}')" style="background:#ffeaea;border:none;border-radius:5px;padding:3px 9px;cursor:pointer;font-size:13px;color:#f44;">ğŸ—‘ï¸</button>
        </div>
      `;
    });
  }
  
  // [2] ëª©ë¡ì¡°íšŒ
  async function fetchAlertSettings() {
    try {
      const res = await fetch(`${API_URL}/alert-settings`, {
        headers: { 'Authorization': `Bearer ${JWT_TOKEN}` }
      });
      const {data} = await res.json();
      return data;
    } catch { return []; }
  }
  
  // [3] ê°œë³„ ì„¤ì • í† ê¸€
  async function toggleAlertActive(id, active) {
    try {
      await fetch(`${API_URL}/alert-settings/${id}`, {
        method:'PATCH',
        headers: {
          'Authorization': `Bearer ${JWT_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ active })
      });
      showToast('ìƒíƒœ ë³€ê²½ë¨!');
      renderAlertList();
    } catch (e) { showToast('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨', true); }
  }
  
  // [4] ì‚­ì œ
  async function deleteAlertSetting(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      await fetch(`${API_URL}/alert-settings/${id}`, {
        method:'DELETE',
        headers: {'Authorization': `Bearer ${JWT_TOKEN}`}
      });
      showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
      renderAlertList();
    } catch (e) { showToast('ì‚­ì œ ì‹¤íŒ¨', true); }
  }
  
  // [5] ìˆ˜ì • (íŒì—… ë“±ìœ¼ë¡œ ì—´ê±°ë‚˜, ê¸°ì¡´ UIì— ë°˜ì˜)
  // ì—¬ê¸°ì„  ë§¤ìš° ê°„ë‹¨í•˜ê²Œ prompt ì‚¬ìš©. ì‹¤ì œë¡œëŠ” ëª¨ë‹¬/í¼ ê¶Œì¥!
  async function editAlertSetting(id) {
    // 1. ê¸°ì¡´ ì •ë³´ ì¡°íšŒ
    const settings = await fetchAlertSettings();
    const curr = settings.find(x=>x.id===id);
    if (!curr) return;
    let newVal = prompt(`ìƒˆë¡œìš´ ì„ê³„ì¹˜(${typeLabel[curr.type]}):`, 
      curr.type==='AIRQUALITY'? getPm10Grade(curr.threshold) : curr.threshold);
    if (!newVal) return;
    if (curr.type !== 'AIRQUALITY') newVal = Number(newVal);
    await fetch(`${API_URL}/alert-settings/${id}`, {
      method:'PATCH',
      headers: {'Authorization': `Bearer ${JWT_TOKEN}`, 'Content-Type': 'application/json'},
      body: JSON.stringify({threshold:newVal})
    });
    showToast('ìˆ˜ì • ì™„ë£Œ');
    renderAlertList();
  }
  
  // ë¯¸ì„¸ë¨¼ì§€ ë“±ê¸‰ ë³€í™˜ util
  function getPm10Grade(val) {
    if (typeof val === "string") return val;
    if (val >= 150) return 'ë§¤ìš° ë‚˜ì¨';
    if (val >= 80) return 'ë‚˜ì¨';
    if (val >= 30) return 'ë³´í†µ';
    return 'ì¢‹ìŒ';
  }
  
  // ìµœì´ˆ ë¡œë”©ì‹œ ëª©ë¡ë„ ì½ì–´ì˜´
  window.onload = function() {
    loadSettingsFromAPI(); // ê¸°ì¡´ ì„¤ì •ë€ ìœ ì§€
    renderAlertList();     // ëª©ë¡ë„ ë¡œë“œ
  }
  
  // showToast í•¨ìˆ˜ëŠ” ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  </script>
  
</body>
</html>